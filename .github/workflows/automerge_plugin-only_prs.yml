name: Automatically merge plugin-only PRs


# Triggered on all PRs either by
# - completion of CI checks, OR
# - tagging with "automerge" or "automerge-web" labels
# Checks if Travis and Jenkins tests pass and PR is automergeable. 
# A PR is automergeable iff labeled "automerge" or originates from 
# web submission (labeled "automerge-web") AND only makes changes to plugins
# (subdirs of /benchmarks, /data, /models, or /metrics). 
# If conditions are met, the PR is automatically approved and merged.


on:
  pull_request:
    types: [labeled]
  check_run:
    types: [completed]
  status:

permissions: write-all

jobs:

  check_test_results:
    name: Check if all tests have passed and PR meets automerge conditions
    runs-on: ubuntu-latest
    outputs:
      ALL_TESTS_PASS: ${{ steps.gettestresults.outputs.TEST_RESULTS }}
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Get test results and ensure automergeable
        id: gettestresults
        run: |
          if [ [ ${{ github.event_name }} == "pull_request" ]]; then
            TRIGGER_SHA=${{ github.event.pull_request.head.sha }}
          else
            TRIGGER_SHA=$GITHUB_SHA
          fi
          echo "test_results=$( python brainscore_vision/submission/check_test_status.py $TRIGGER_SHA )"
          echo "::set-output name=TEST_RESULTS::$test_results"


  automerge:
    name: If tests pass and PR is automergeable, approve and merge
    runs-on: ubuntu-latest
    needs: check_test_results
    if: ${{ needs.check_test_results.outputs.ALL_TESTS_PASS == 'True' }}
    steps:
      - name: Auto Approve
        uses: hmarr/auto-approve-action@v3.1.0

      - name: Auto Merge (GitHub submissions)
        uses: plm9606/automerge_actions@1.2.2
        with:
          github-token: ${{ secrets.WORKFLOW_TOKEN }}
          label-name: "automerge"
          merge-method: "squash"
          auto-delete: "true"

      - name: Auto Merge (brain-score.org submissions)
        uses: plm9606/automerge_actions@1.2.2
        with:
          github-token: ${{ secrets.WORKFLOW_TOKEN }}
          label-name: "automerge-web"
          merge-method: "squash"
          auto-delete: "true"
